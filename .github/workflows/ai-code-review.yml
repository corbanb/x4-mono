name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ai-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Check API key
        id: check-key
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [[ -n "$ANTHROPIC_API_KEY" ]]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "ANTHROPIC_API_KEY not configured — skipping AI review"
          fi

      - uses: actions/checkout@v4
        if: steps.check-key.outputs.available == 'true'
        with:
          fetch-depth: 0

      - name: Get PR diff
        if: steps.check-key.outputs.available == 'true'
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- ':(exclude)bun.lock' ':(exclude)*.json' | head -c 50000)
          {
            echo "diff<<DIFF_EOF"
            echo "$DIFF"
            echo "DIFF_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Review with Claude
        if: steps.check-key.outputs.available == 'true'
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const diff = process.env.DIFF_CONTENT;
            if (!diff || diff.trim().length === 0) {
              console.log('No meaningful diff to review');
              return;
            }

            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-5-20250929',
                max_tokens: 4096,
                messages: [{
                  role: 'user',
                  content: `You are a code reviewer for a TypeScript monorepo (Bun, Hono, tRPC, Next.js, Drizzle ORM). Review this PR diff and provide concise feedback on:

            1. **Security issues** (CRITICAL — auth bypasses, injection, exposed secrets)
            2. **Type safety** (any usage, missing validation, unsafe casts)
            3. **Bugs or edge cases** (null handling, race conditions, error paths)
            4. **Performance** (N+1 queries, unnecessary re-renders, missing indexes)

            Only flag real issues. Skip nitpicks, style preferences, and things that are fine. If the code looks good, say so briefly.

            \`\`\`diff
            ${diff}
            \`\`\``
                }]
              })
            });

            const data = await response.json();
            const review = data.content?.[0]?.text ?? 'Unable to generate review.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Claude Code Review\n\n${review}\n\n---\n*Automated review by Claude Sonnet*`
            });
        env:
          DIFF_CONTENT: ${{ steps.diff.outputs.diff }}
